<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cotizador Din√°mico - Learcam V19</title>
  <style>
    :root{
      --bg-grad-a:#667eea;
      --bg-grad-b:#764ba2;
      --primary:#3498db;
      --primary-dark:#2c3e50;
      --surface:#f8f9fa;
      --border:#dee2e6;
      --muted:#6b7280;
      --ok:#2ecc71;
      --warn:#e67e22;
      --bad:#e74c3c;
      --chip-bg:#eef2ff;
      --chip-bd:#cfd8ff;
      --chip-fg:#2c3e50;
      --kpi-bd:#e9eefc;
      --kpi-bg:#ffffff;
      --headline:#2c3e50;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,sans-serif;
      background:linear-gradient(135deg,var(--bg-grad-a) 0%,var(--bg-grad-b) 100%);
      min-height:100vh;padding:20px;color:#111827
    }
    .container{
      max-width:1400px;margin:0 auto;background:#fff;border-radius:20px;
      box-shadow:0 16px 32px rgba(0,0,0,.08);overflow:hidden
    }
    .header{
      background:linear-gradient(45deg,var(--primary-dark),var(--primary));
      color:#fff;padding:22px;text-align:center
    }
    .header h1{font-size:2rem;margin-bottom:4px;font-weight:800;letter-spacing:.2px}
    .header p{opacity:.9}
    .main-content{display:grid;grid-template-columns:30% 70%;min-height:600px}
    /* IZQUIERDA */
    .form-section{padding:20px;background:var(--surface);border-right:1px solid var(--border);overflow-y:auto}
    details{
      margin-bottom:14px;border:1px solid #ddd;border-radius:10px;background:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,.04); transition:box-shadow .2s ease
    }
    details[open]{box-shadow:0 4px 12px rgba(0,0,0,.06)}
    summary{
      padding:12px 16px;font-weight:700;cursor:pointer;
      background:var(--primary);color:#fff;border-radius:10px 10px 0 0;
      display:flex;align-items:center;gap:8px
    }
    summary::marker{content:""}
    .form-group{padding:12px 16px}
    .form-group label{display:block;margin-bottom:6px;font-size:.9rem;color:var(--headline)}
    .form-group input{width:100%;padding:9px;border:1px solid #ccc;border-radius:8px;font-size:.95rem}
    /* DERECHA */
    .results-section{padding:24px;background:#fff;overflow-y:auto}
    .section-title{font-size:1.4rem;margin-bottom:14px;color:var(--headline);font-weight:800}
    .semaforo-container{display:flex;justify-content:center;gap:16px;margin-bottom:10px}
    .semaforo-item{
      display:flex;flex-direction:column;align-items:center;
      padding:10px 14px;border-radius:12px;min-width:92px;
      font-weight:800;color:#fff;opacity:.4;letter-spacing:.2px
    }
    .semaforo-aprobar{background:linear-gradient(135deg,#27ae60,#2ecc71)}
    .semaforo-revisar{background:linear-gradient(135deg,#f39c12,#e67e22)}
    .semaforo-rechazar{background:linear-gradient(135deg,#e74c3c,#c0392b)}
    .semaforo-activo{opacity:1;box-shadow:0 0 0 3px rgba(0,0,0,.06) inset,0 10px 18px rgba(0,0,0,.15)}
    .alertas-container{margin:12px 0}
    .alerta{padding:10px 12px;border-radius:8px;margin-bottom:8px;font-size:.92rem}
    .critica{background:#ffeaea;border:1px solid #ffd2d2;color:#a11e2a}
    .atencion{background:#fff8e1;border:1px solid #ffe7ad;color:#7a5a00}
    .oportunidad{background:#e8f5e9;border:1px solid #c8e6c9;color:#235d2a}
    .summary-metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin:14px 0 22px}
    .metric-card{
      background:linear-gradient(135deg,#6d7fe9,#7b6ad6);
      color:#fff;padding:18px;border-radius:12px;text-align:center;
      box-shadow:0 6px 16px rgba(102,126,234,.18)
    }
    .metric-label{font-size:.85rem;margin-bottom:4px;opacity:.95}
    .metric-value{font-size:1.25rem;font-weight:900;letter-spacing:.2px;font-variant-numeric:tabular-nums}
    .card{
      background:var(--surface);border-radius:12px;padding:18px;
      border:1px solid var(--border);box-shadow:0 2px 8px rgba(0,0,0,.04);
      margin-bottom:18px
    }
    .card h3{margin-bottom:10px;font-size:1.05rem;color:var(--primary-dark);font-weight:800;letter-spacing:.2px}
    .er-table{width:100%;border-collapse:collapse;margin-top:6px}
    .er-table th,.er-table td{padding:8px;border-bottom:1px solid #e8e8e8;text-align:right}
    .er-table th{background:#edf6ff;color:var(--headline);font-weight:800}
    .er-table td.label{text-align:left}
    .er-total{font-weight:800;background:#f6f7fb}
    .er-final{font-weight:900;background:#4caf50;color:#fff}
    .er-final.neg{background:#f44336}
    .breakdown-item{display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:6px 0}
    /* ‚Äî‚Äî‚Äî FORMA DE PAGO (alineada al resto) ‚Äî‚Äî‚Äî */
    .paycard{
      background:linear-gradient(135deg,#ffffff 0%,#f7faff 100%);
      border:1px solid var(--kpi-bd);border-radius:14px;padding:14px;
      box-shadow:0 6px 18px rgba(52,152,219,.08)
    }
    .pay-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px}
    .pay-title{
      font-weight:800;color:var(--headline);font-size:1.05rem;letter-spacing:.2px;
      display:flex;gap:8px;align-items:center
    }
    .pay-chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{
      font-size:.82rem;padding:4px 10px;border-radius:999px;border:1px solid var(--chip-bd);
      background:var(--chip-bg);color:var(--chip-fg);font-weight:700
    }
    .pay-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:8px}
    .kpi{
      background:var(--kpi-bg);border:1px solid var(--kpi-bd);border-radius:10px;padding:10px;text-align:center
    }
    .kpi .label{font-size:.8rem;color:var(--muted);margin-bottom:6px}
    .kpi .value{
      font-size:1.02rem;font-weight:900;color:#111827;letter-spacing:.2px;font-variant-numeric:tabular-nums
    }
    .pay-progress{margin-top:10px;height:6px;border-radius:999px;background:#e9eefc;overflow:hidden}
    .pay-progress .adv{height:100%;background:linear-gradient(90deg,#22c55e,#86efac)}
    @media(max-width:1100px){.pay-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:900px){.main-content{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üíº Cotizador Learcam V19</h1>
      <p>Sistema de an√°lisis de contribuci√≥n y rentabilidad</p>
    </div>

    <div class="main-content">
      <!-- IZQUIERDA -->
      <div class="form-section">
        <details open>
          <summary>üìù Variables de la Operaci√≥n</summary>
          <div class="form-group"><label>Valor FOB (USD)</label><input type="number" id="valorFOB" value="27000"></div>
          <div class="form-group"><label>Valor de Venta con IVA (USD)</label><input type="number" id="valorVenta" value="48288"></div>
          <div class="form-group"><label>Anticipo (%)</label><input type="number" id="anticipo" value="30"></div>
          <div class="form-group"><label>Cantidad de Cuotas</label><input type="number" id="cuotas" value="8"></div>
          <div class="form-group"><label>Tasa Financiaci√≥n Anual (%)</label><input type="number" id="tasaFinanciacion" value="0"></div>
          <div class="form-group"><label>Tasa Descuento Anual (%)</label><input type="number" id="tasaDescuento" value="40"></div>
          <div class="form-group"><label><input type="checkbox" id="ventaDistribuidor" checked> ¬øVenta por distribuidor?</label></div>
        </details>

        <details>
          <summary>‚öôÔ∏è Configuraci√≥n del Modelo</summary>
          <div class="form-group"><label>Gastos Fijos Mensuales (USD)</label><input type="number" id="gastosFijos" value="24500"></div>
          <div class="form-group"><label>IVA (%)</label><input type="number" id="iva" value="10.5"></div>
          <div class="form-group"><label>Comisi√≥n Concesionario (%)</label><input type="number" id="comisionConcesionario" value="10"></div>
        </details>

        <details>
          <summary>üìä Gastos Variables (par√°metros)</summary>
          <div class="form-group"><label>Despachante (%)</label><input type="number" id="despachantePorcentaje" value="1.5"></div>
          <div class="form-group"><label>Flete (USD)</label><input type="number" id="flete" value="2000"></div>
          <div class="form-group"><label>Seguro (%)</label><input type="number" id="seguroPorcentaje" value="1.5"></div>
          <div class="form-group"><label>Gastos Varios (%)</label><input type="number" id="gastosVariosPorcentaje" value="2.0"></div>
          <div class="form-group"><label>IIBB Percepci√≥n (%)</label><input type="number" id="ingBrutosPercepcionPorcentaje" value="3.0"></div>
          <div class="form-group"><label>IIBB Saldo (%)</label><input type="number" id="ingBrutosSaldoPorcentaje" value="3.5"></div>
          <div class="form-group"><label>Tasa Seguridad (USD)</label><input type="number" id="tasaSeguridad" value="75"></div>
        </details>

        <details>
          <summary>‚ö†Ô∏è Par√°metros de Sem√°foro y Alertas</summary>
          <div class="form-group"><label>Margen Neto M√≠nimo (%)</label><input type="number" id="alertaMargenMinimo" value="15"></div>
          <div class="form-group"><label>Punto Equilibrio M√°ximo (u.)</label><input type="number" id="alertaEquilibrioMaximo" value="20"></div>
          <div class="form-group"><label>Margen Bruto Excelente (%)</label><input type="number" id="alertaMargenExcelente" value="30"></div>
          <div class="form-group"><label>Tasa Descuento Cr√≠tica (%)</label><input type="number" id="alertaTasaCritica" value="35"></div>
        </details>
      </div>

      <!-- DERECHA -->
      <div class="results-section">
        <h2 class="section-title">üìä Resultados</h2>
        <div id="resultados"><p>Modific√° los campos para ver resultados en vivo.</p></div>
      </div>
    </div>
  </div>

  <script>
    function formatCurrency(v){return new Intl.NumberFormat('es-US',{style:'currency',currency:'USD'}).format(v)}
    function formatPercentage(v){return v.toFixed(2)+'%'}
    function clamp(n){return isFinite(n)?n:0}

    function generarAlertas(calc,params){
      const alertas=[]
      if(calc.contrib<0) alertas.push({tipo:'critica',msg:'üö® La operaci√≥n genera p√©rdidas.'})
      if(calc.margenNeto<params.margenMin) alertas.push({tipo:'critica',msg:`üìâ Margen neto (${calc.margenNeto.toFixed(1)}%) menor al m√≠nimo (${params.margenMin}%).`})
      if(calc.puntoEq>params.eqMax) alertas.push({tipo:'critica',msg:`‚ö° Punto de equilibrio alto (${calc.puntoEq.toFixed(1)} u.).`})
      if(calc.tasaDesc>params.tasaCrit) alertas.push({tipo:'critica',msg:`üí∏ Tasa descuento (${calc.tasaDesc}%) supera el l√≠mite cr√≠tico (${params.tasaCrit}%).`})
      if(calc.margenBrutoPct>=params.margenExc) alertas.push({tipo:'oportunidad',msg:`üéØ Excelente margen bruto (${calc.margenBrutoPct.toFixed(1)}%).`})
      return alertas
    }

    function calcular(){
      // INPUTS
      const valorFOB=+document.getElementById('valorFOB').value||0
      const valorVenta=+document.getElementById('valorVenta').value||0
      const anticipo=+document.getElementById('anticipo').value||0
      const cuotas=+document.getElementById('cuotas').value||1
      const tasaFin=+document.getElementById('tasaFinanciacion').value||0
      const tasaDesc=+document.getElementById('tasaDescuento').value||0
      const gastosFijos=+document.getElementById('gastosFijos').value||0
      const iva=+document.getElementById('iva').value||0
      const comision=+document.getElementById('comisionConcesionario').value||0
      const despP=+document.getElementById('despachantePorcentaje').value||0
      const flete=+document.getElementById('flete').value||0
      const segP=+document.getElementById('seguroPorcentaje').value||0
      const gvP=+document.getElementById('gastosVariosPorcentaje').value||0
      const iibbP=+document.getElementById('ingBrutosPercepcionPorcentaje').value||0
      const iibbSaldoP=+document.getElementById('ingBrutosSaldoPorcentaje').value||0
      const tasaSeg=+document.getElementById('tasaSeguridad').value||0
      const ventaDist=document.getElementById('ventaDistribuidor').checked

      const params={
        margenMin:+document.getElementById('alertaMargenMinimo').value||15,
        eqMax:+document.getElementById('alertaEquilibrioMaximo').value||20,
        margenExc:+document.getElementById('alertaMargenExcelente').value||30,
        tasaCrit:+document.getElementById('alertaTasaCritica').value||35
      }

      // VENTAS
      const ventaNeta = valorVenta/(1+iva/100)
      const costoMerc = valorFOB

      // BASE y SEGURO iterativo
      let base = valorFOB + flete
      let seguro = base*segP/100
      base = valorFOB + flete + seguro
      seguro = base*segP/100
      base = valorFOB + flete + seguro

      // GASTOS VARIABLES
      const desp = base*despP/100
      const gv  = base*gvP/100
      const iibbPerc = base*iibbP/100
      const iibbSaldo = Math.max(0,(ventaNeta*iibbSaldoP/100) - iibbPerc)
      const gastosVar = desp + flete + seguro + gv + iibbPerc + iibbSaldo + tasaSeg

      // COMISI√ìN
      const comisionTot = ventaDist ? ventaNeta*comision/100 : 0

      // MARGEN BRUTO
      const margenBrutoMonto = ventaNeta - costoMerc - gastosVar - comisionTot
      const margenBrutoPct = ventaNeta>0 ? (margenBrutoMonto/ventaNeta)*100 : 0

      // FINANCIACI√ìN
      const montoAnt = valorVenta*anticipo/100
      const montoFin = valorVenta - montoAnt
      const tasaM    = tasaFin/100/12
      let cuota = 0
      if (cuotas>0){
        cuota = (tasaM===0) ? (montoFin/cuotas)
                : (montoFin*tasaM*Math.pow(1+tasaM,cuotas))/(Math.pow(1+tasaM,cuotas)-1)
      }
      const totalCuotas = cuota*cuotas
      const costoFin    = totalCuotas - montoFin

      // DESCUENTO (VP)
      const tasaDescM   = tasaDesc/100/12
      let vp = 0
      for (let i=1;i<=cuotas;i++){ vp += cuota/Math.pow(1+tasaDescM,i) }
      const perdidaFin  = totalCuotas - vp

      // RESULTADOS
      const ingresoTot  = ventaNeta + costoFin
      const totalCostos = costoMerc + gastosVar + comisionTot + perdidaFin
      const contrib     = ingresoTot - totalCostos
      const margenNeto  = ingresoTot>0 ? (contrib/ingresoTot)*100 : 0
      const puntoEq     = contrib>0 ? (gastosFijos/contrib) : 999

      // DECISI√ìN
      let decision='rechazar'
      if(contrib>0 && margenNeto>=params.margenMin && puntoEq<=params.eqMax){ decision='aprobar' }
      else if(contrib>0){ decision='revisar' }

      // ALERTAS
      const alertas = generarAlertas(
        {contrib,margenNeto,puntoEq,tasaDesc,margenBrutoPct},
        params
      )

      // % barra anticipo (cap 100)
      const advPct = Math.max(0,Math.min(100,anticipo||0))

      // RENDER
      document.getElementById('resultados').innerHTML = `
        <div class="semaforo-container">
          <div class="semaforo-item semaforo-aprobar ${decision==='aprobar'?'semaforo-activo':''}">üü¢ Aprobar</div>
          <div class="semaforo-item semaforo-revisar ${decision==='revisar'?'semaforo-activo':''}">üü° Revisar</div>
          <div class="semaforo-item semaforo-rechazar ${decision==='rechazar'?'semaforo-activo':''}">üî¥ Rechazar</div>
        </div>

        <div class="alertas-container">
          ${alertas.map(a=>`<div class="alerta ${a.tipo}">${a.msg}</div>`).join('')}
        </div>

        <div class="summary-metrics">
          <div class="metric-card"><div class="metric-label">Contribuci√≥n</div><div class="metric-value">${formatCurrency(contrib)}</div></div>
          <div class="metric-card"><div class="metric-label">Margen Bruto %</div><div class="metric-value">${formatPercentage(margenBrutoPct)}</div></div>
          <div class="metric-card"><div class="metric-label">Margen Neto %</div><div class="metric-value">${formatPercentage(margenNeto)}</div></div>
          <div class="metric-card"><div class="metric-label">Punto de Equilibrio</div><div class="metric-value">${clamp(puntoEq).toFixed(2)} u.</div></div>
        </div>

        <!-- Forma de pago (alineada al resto) -->
        <div class="paycard">
          <div class="pay-header">
            <div class="pay-title">üí≥ Forma de Pago</div>
            <div class="pay-chips">
              <span class="chip">Anticipo ${anticipo.toFixed(0)}%</span>
              <span class="chip">${cuotas} cuotas</span>
              <span class="chip">TNA ${tasaFin.toFixed(1)}%</span>
              <span class="chip">Tasa desc. ${tasaDesc.toFixed(1)}%</span>
            </div>
          </div>
          <div class="pay-grid">
            <div class="kpi"><div class="label">Venta Total</div><div class="value">${formatCurrency(valorVenta)}</div></div>
            <div class="kpi"><div class="label">Anticipo</div><div class="value">${formatCurrency(montoAnt)}</div></div>
            <div class="kpi"><div class="label">Financiado</div><div class="value">${formatCurrency(montoFin)}</div></div>
            <div class="kpi"><div class="label">Cuota</div><div class="value">${formatCurrency(cuota)}</div></div>
          </div>
          <div class="pay-progress" aria-label="Porcentaje de anticipo"><div class="adv" style="width:${advPct}%;"></div></div>
        </div>

        <!-- Estado de resultados -->
        <div class="card">
          <h3>üìä Estado de Resultados</h3>
          <table class="er-table">
            <tr><th colspan="2">INGRESOS</th></tr>
            <tr><td class="label">Venta Neta</td><td>${formatCurrency(ventaNeta)}</td></tr>
            <tr><td class="label">Costo Financiero</td><td>${formatCurrency(costoFin)}</td></tr>
            <tr class="er-total"><td class="label">Total Ingresos</td><td>${formatCurrency(ingresoTot)}</td></tr>

            <tr><th colspan="2">COSTOS Y GASTOS</th></tr>
            <tr><td class="label">FOB</td><td>${formatCurrency(costoMerc)}</td></tr>
            <tr><td class="label">Gastos Variables</td><td>${formatCurrency(gastosVar)}</td></tr>
            ${ventaDist?`<tr><td class="label">Comisi√≥n Distribuidor</td><td>${formatCurrency(comisionTot)}</td></tr>`:''}
            <tr><td class="label">P√©rdida Financiera (descuento)</td><td>${formatCurrency(perdidaFin)}</td></tr>
            <tr class="er-total"><td class="label">Total Costos</td><td>${formatCurrency(totalCostos)}</td></tr>

            <tr class="er-final ${contrib<0?'neg':''}"><td class="label">Resultado Neto (Contribuci√≥n)</td><td>${formatCurrency(contrib)}</td></tr>
          </table>
        </div>

        <!-- Gastos variables: acorde√≥n en la derecha -->
        <details class="card">
          <summary>üîç Detalle de Gastos Variables</summary>
          <div class="breakdown-item"><span>Base imponible (FOB + Flete + Seguro)</span><span>${formatCurrency(base)}</span></div>
          <div class="breakdown-item"><span>Despachante (${despP}%)</span><span>${formatCurrency(desp)}</span></div>
          <div class="breakdown-item"><span>Flete</span><span>${formatCurrency(flete)}</span></div>
          <div class="breakdown-item"><span>Seguro (${segP}%)</span><span>${formatCurrency(seguro)}</span></div>
          <div class="breakdown-item"><span>Gastos varios (${gvP}%)</span><span>${formatCurrency(gv)}</span></div>
          <div class="breakdown-item"><span>IIBB Percepci√≥n (${iibbP}%)</span><span>${formatCurrency(iibbPerc)}</span></div>
          <div class="breakdown-item"><span>IIBB Saldo (${iibbSaldoP}%)</span><span>${formatCurrency(iibbSaldo)}</span></div>
          <div class="breakdown-item"><span>Tasa de seguridad</span><span>${formatCurrency(tasaSeg)}</span></div>
        </details>
      `
    }

    // Auto-recalcular con debounce
    document.addEventListener('DOMContentLoaded',()=>{
      const inputs=document.querySelectorAll('input')
      inputs.forEach(inp=>{
        inp.addEventListener('input',()=>{
          clearTimeout(inp.__t); inp.__t=setTimeout(calcular,320)
        })
      })
      calcular()
    })
  </script>
</body>
</html>
