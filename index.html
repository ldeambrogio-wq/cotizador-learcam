<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador Din√°mico - Learcam</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 45% 55%;
            gap: 0;
            min-height: 600px;
        }

        .form-section {
            padding: 30px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
        }

        .results-section {
            padding: 30px;
            background: white;
        }

        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }

        .form-category {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .form-category h3 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-category h3::before {
            content: "üìä";
            font-size: 1.1rem;
        }

        small {
            display: block;
            margin-top: 3px;
            font-style: italic;
            color: #6c757d;
            font-size: 0.85em;
        }

        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .calculate-btn:hover {
            background: linear-gradient(45deg, #2980b9, #1e6b96);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .results-grid {
            display: grid;
            gap: 20px;
        }

        .result-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #3498db;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .result-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .result-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #27ae60;
        }

        .result-value.negative {
            color: #e74c3c;
        }

        .result-breakdown {
            margin-bottom: 25px;
            padding: 25px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .result-breakdown h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: bold;
            color: #2c3e50;
            border-top: 2px solid #3498db;
            padding-top: 15px;
            margin-top: 10px;
        }

        .breakdown-label {
            color: #6c757d;
            font-size: 0.95rem;
        }

        .breakdown-value {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        .summary-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .metric-card {
            text-align: center;
            padding: 25px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 1.6rem;
            font-weight: bold;
        }

        .semaforo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        .semaforo-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            opacity: 0.3;
            min-width: 80px;
        }

        .semaforo-aprobar {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .semaforo-revisar {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .semaforo-rechazar {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .semaforo-activo {
            opacity: 1;
            border-color: #2c3e50;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            transform: scale(1.02);
        }

        .semaforo-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .semaforo-text {
            font-size: 0.75rem;
        }

        .alertas-container {
            margin-bottom: 25px;
        }

        .alerta {
            padding: 15px 18px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .alerta-critica {
            background: #ffeaea;
            border-left: 4px solid #e74c3c;
            color: #c0392b;
        }

        .alerta-atencion {
            background: #fff3cd;
            border-left: 4px solid #f39c12;
            color: #856404;
        }

        .alerta-oportunidad {
            background: #d4edda;
            border-left: 4px solid #27ae60;
            color: #155724;
        }

        .escenarios-container {
            margin-top: 20px;
        }

        .escenario-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .escenario-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .escenario-metricas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 0.85rem;
        }

        .escenario-metrica {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .escenario-label {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .escenario-value {
            font-weight: bold;
            color: #2c3e50;
        }

        .escenario-value.negativo {
            color: #e74c3c;
        }

        .config-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 8px;
            margin-bottom: 6px;
            align-items: center;
        }

        .config-row label {
            font-size: 0.8rem;
            color: #495057;
        }

        .config-row input {
            padding: 5px 6px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .form-section {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .semaforo-container {
                flex-direction: column;
                gap: 10px;
            }
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ffeaa7;
            margin-bottom: 20px;
        }

        .success {
            background: #d1edff;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #bee5eb;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíº Cotizador Learcam</h1>
            <p>Sistema de an√°lisis de contribuci√≥n y rentabilidad comercial</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title">üìù Datos de la Operaci√≥n</h2>
                
                <div class="form-category">
                    <h3>Variables de la Operaci√≥n</h3>
                    <div class="form-group">
                        <label for="valorFOB">Valor FOB (USD):</label>
                        <input type="number" id="valorFOB" step="0.01" value="10000">
                    </div>
                    <div class="form-group">
                        <label for="valorVenta">Valor de Venta con IVA (USD):</label>
                        <input type="number" id="valorVenta" step="0.01" value="15000">
                    </div>
                    <div class="form-group">
                        <label for="anticipo">Anticipo (%):</label>
                        <input type="number" id="anticipo" step="0.1" value="30">
                    </div>
                    <div class="form-group">
                        <label for="cuotas">Cantidad de Cuotas:</label>
                        <input type="number" id="cuotas" step="1" value="12">
                    </div>
                    <div class="form-group">
                        <label for="tasaFinanciacion">Tasa de Financiaci√≥n Anual (%):</label>
                        <input type="number" id="tasaFinanciacion" step="0.1" value="15">
                    </div>
                    <div class="form-group">
                        <label for="tasaDescuento">Tasa de Descuento Anual (%):</label>
                        <input type="number" id="tasaDescuento" step="0.1" value="12">
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="ventaDistribuidor">
                            <label for="ventaDistribuidor">¬øVenta realizada por distribuidor?</label>
                        </div>
                    </div>
                </div>

                <div class="form-category">
                    <h3>Configuraci√≥n del Modelo de Negocio</h3>
                    <div class="form-group">
                        <label for="gastosFijos">Gastos Fijos Mensuales (USD):</label>
                        <input type="number" id="gastosFijos" step="0.01" value="5000">
                    </div>
                    <div class="form-group">
                        <label for="iva">IVA (%):</label>
                        <input type="number" id="iva" step="0.1" value="10.5">
                    </div>
                    <div class="form-group">
                        <label for="comisionConcesionario">Comisi√≥n Concesionario (%):</label>
                        <input type="number" id="comisionConcesionario" step="0.1" value="10">
                    </div>
                </div>

                <div class="form-category">
                    <h3>Gastos Variables</h3>
                    <div class="form-group">
                        <label for="despachantePorcentaje">Despachante de Aduana (%):</label>
                        <input type="number" id="despachantePorcentaje" step="0.1" value="1.5">
                        <small>Calculado sobre FOB + Flete + Seguro</small>
                    </div>
                    <div class="form-group">
                        <label for="flete">Flete Caxias / Pilar (USD):</label>
                        <input type="number" id="flete" step="0.01" value="300">
                    </div>
                    <div class="form-group">
                        <label for="seguroPorcentaje">Seguro Mercader√≠a (%):</label>
                        <input type="number" id="seguroPorcentaje" step="0.1" value="1.5">
                        <small>Calculado sobre FOB + Flete + Seguro</small>
                    </div>
                    <div class="form-group">
                        <label for="gastosVariosPorcentaje">Gastos Varios / Comisiones Comerciales (%):</label>
                        <input type="number" id="gastosVariosPorcentaje" step="0.1" value="2.0">
                        <small>Calculado sobre FOB + Flete + Seguro</small>
                    </div>
                    <div class="form-group">
                        <label for="ingBrutosPercepcionPorcentaje">Ingresos Brutos Percepci√≥n (%):</label>
                        <input type="number" id="ingBrutosPercepcionPorcentaje" step="0.1" value="3.0">
                        <small>Calculado sobre FOB + Flete + Seguro</small>
                    </div>
                    <div class="form-group">
                        <label for="ingBrutosSaldoPorcentaje">Impuesto Ingresos Brutos Saldo (%):</label>
                        <input type="number" id="ingBrutosSaldoPorcentaje" step="0.1" value="3.5">
                        <small>Calculado sobre Venta sin IVA menos Percepci√≥n</small>
                    </div>
                    <div class="form-group">
                        <label for="tasaSeguridad">Tasa de Seguridad (USD):</label>
                        <input type="number" id="tasaSeguridad" step="0.01" value="75">
                    </div>
                </div>

                <button class="calculate-btn" onclick="calcular()">üîÑ Calcular An√°lisis</button>
            </div>

            <div class="results-section">
                <h2 class="section-title">üìä An√°lisis de Contribuci√≥n</h2>
                <div id="resultados">
                    <div class="warning">
                        <strong>üí° Informaci√≥n:</strong> Complete los datos del formulario y haga clic en "Calcular An√°lisis" para ver los resultados.
                    </div>
                </div>
                
                <!-- Configuraci√≥n de Alertas movida aqu√≠ -->
                <div class="form-category" style="margin-top: 30px;">
                    <h3>‚öôÔ∏è Configuraci√≥n de Alertas</h3>
                    <div class="config-row">
                        <label>Margen Neto M√≠nimo (%):</label>
                        <input type="number" id="alertaMargenMinimo" step="0.1" value="15">
                    </div>
                    <div class="config-row">
                        <label>Punto Equilibrio M√°ximo (unidades):</label>
                        <input type="number" id="alertaEquilibrioMaximo" step="0.1" value="20">
                    </div>
                    <div class="config-row">
                        <label>Margen Bruto Excelente (%):</label>
                        <input type="number" id="alertaMargenExcelente" step="0.1" value="30">
                    </div>
                    <div class="config-row">
                        <label>Tasa Descuento Cr√≠tica (%):</label>
                        <input type="number" id="alertaTasaCritica" step="0.1" value="35">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function formatPercentage(value) {
            return `${value.toFixed(2)}%`;
        }

        function generarEscenarios(calc) {
            const escenarioBase = {
                nombre: "üìä Escenario Base",
                contribucion: calc.contribucionNeta,
                margenNeto: calc.margenNetoPorcentaje,
                puntoEquilibrio: calc.puntoEquilibrio
            };
            
            const ventaOptimista = calc.ventaNeta * 1.2;
            const gastosOptimistas = calc.gastosVariablesTotales * 0.9;
            const contribucionOptimista = (ventaOptimista + calc.costoFinanciero) - (calc.costoMercaderia + gastosOptimistas + calc.comisionTotal + calc.perdidaFinanciera);
            const margenNetoOptimista = ((ventaOptimista + calc.costoFinanciero) > 0) ? (contribucionOptimista / (ventaOptimista + calc.costoFinanciero)) * 100 : 0;
            
            const escenarioOptimista = {
                nombre: "üöÄ Escenario Optimista (+20% precio, -10% costos)",
                contribucion: contribucionOptimista,
                margenNeto: margenNetoOptimista,
                puntoEquilibrio: contribucionOptimista > 0 ? (parseFloat(document.getElementById('gastosFijos').value) || 0) / contribucionOptimista : 999
            };
            
            const ventaPesimista = calc.ventaNeta * 0.8;
            const gastosPesimistas = calc.gastosVariablesTotales * 1.3;
            const contribucionPesimista = (ventaPesimista + calc.costoFinanciero) - (calc.costoMercaderia + gastosPesimistas + calc.comisionTotal + calc.perdidaFinanciera);
            const margenNetoPesimista = ((ventaPesimista + calc.costoFinanciero) > 0) ? (contribucionPesimista / (ventaPesimista + calc.costoFinanciero)) * 100 : 0;
            
            const escenarioPesimista = {
                nombre: "‚ö†Ô∏è Escenario Pesimista (-20% precio, +30% costos)",
                contribucion: contribucionPesimista,
                margenNeto: margenNetoPesimista,
                puntoEquilibrio: contribucionPesimista > 0 ? (parseFloat(document.getElementById('gastosFijos').value) || 0) / contribucionPesimista : 999
            };
            
            return [escenarioBase, escenarioOptimista, escenarioPesimista];
        }

        function generarAlertas(calc) {
            const alertas = [];
            
            if (calc.contribucionNeta <= 0) {
                alertas.push({
                    tipo: 'critica',
                    icono: 'üö®',
                    mensaje: 'Operaci√≥n genera P√âRDIDAS. Requiere reestructuraci√≥n inmediata.'
                });
            }
            
            if (calc.margenNetoPorcentaje < calc.alertas.margenMinimo) {
                alertas.push({
                    tipo: 'critica',
                    icono: 'üìâ',
                    mensaje: `Margen neto (${calc.margenNetoPorcentaje.toFixed(1)}%) por debajo del m√≠nimo (${calc.alertas.margenMinimo}%).`
                });
            }
            
            if (calc.puntoEquilibrio > calc.alertas.equilibrioMaximo) {
                alertas.push({
                    tipo: 'critica',
                    icono: '‚ö°',
                    mensaje: `Punto equilibrio muy alto: ${calc.puntoEquilibrio.toFixed(1)} operaciones/mes.`
                });
            }
            
            if (calc.tasaDescuento > calc.alertas.tasaCritica) {
                alertas.push({
                    tipo: 'critica',
                    icono: 'üí∏',
                    mensaje: `Tasa descuento (${calc.tasaDescuento}%) genera p√©rdida financiera excesiva.`
                });
            }
            
            if (calc.margenNetoPorcentaje >= calc.alertas.margenMinimo && calc.margenNetoPorcentaje < calc.alertas.margenMinimo + 5) {
                alertas.push({
                    tipo: 'atencion',
                    icono: '‚ö†Ô∏è',
                    mensaje: 'Margen neto en zona de riesgo. Monitorear de cerca.'
                });
            }
            
            if (calc.perdidaFinanciera > calc.costoFinanciero * 3) {
                alertas.push({
                    tipo: 'atencion',
                    icono: 'üí∞',
                    mensaje: 'P√©rdida financiera alta. Considerar acortar plazos.'
                });
            }
            
            if (calc.margenBrutoPorc > calc.alertas.margenExcelente) {
                alertas.push({
                    tipo: 'oportunidad',
                    icono: 'üéØ',
                    mensaje: `Excelente margen bruto (${calc.margenBrutoPorc.toFixed(1)}%). Oportunidad de crecimiento.`
                });
            }
            
            if (calc.puntoEquilibrio < 5) {
                alertas.push({
                    tipo: 'oportunidad',
                    icono: '‚úÖ',
                    mensaje: 'Punto equilibrio muy favorable. Operaci√≥n altamente escalable.'
                });
            }
            
            return alertas;
        }

        function determinarSemaforo(calc) {
            let score = 0;
            
            if (calc.contribucionNeta > 0) score += 3;
            if (calc.margenNetoPorcentaje >= calc.alertas.margenMinimo) score += 3;
            if (calc.puntoEquilibrio <= calc.alertas.equilibrioMaximo) score += 2;
            if (calc.margenBrutoPorc >= 20) score += 2;
            
            if (calc.tasaDescuento > calc.alertas.tasaCritica) score -= 2;
            if (calc.perdidaFinanciera > calc.costoFinanciero * 4) score -= 1;
            
            if (score >= 8) return 'aprobar';
            if (score >= 5) return 'revisar';
            return 'rechazar';
        }

        function calcular() {
            const gastosFijos = parseFloat(document.getElementById('gastosFijos').value) || 0;
            const iva = parseFloat(document.getElementById('iva').value) || 0;
            const comisionConcesionario = parseFloat(document.getElementById('comisionConcesionario').value) || 0;
            
            const valorFOB = parseFloat(document.getElementById('valorFOB').value) || 0;
            const valorVenta = parseFloat(document.getElementById('valorVenta').value) || 0;
            const anticipo = parseFloat(document.getElementById('anticipo').value) || 0;
            const cuotas = parseInt(document.getElementById('cuotas').value) || 1;
            const tasaFinanciacion = parseFloat(document.getElementById('tasaFinanciacion').value) || 0;
            const tasaDescuento = parseFloat(document.getElementById('tasaDescuento').value) || 0;
            const ventaDistribuidor = document.getElementById('ventaDistribuidor').checked;
            
            const alertaMargenMinimo = parseFloat(document.getElementById('alertaMargenMinimo').value) || 15;
            const alertaEquilibrioMaximo = parseFloat(document.getElementById('alertaEquilibrioMaximo').value) || 20;
            const alertaMargenExcelente = parseFloat(document.getElementById('alertaMargenExcelente').value) || 30;
            const alertaTasaCritica = parseFloat(document.getElementById('alertaTasaCritica').value) || 35;
            
            const despachantePorcentaje = parseFloat(document.getElementById('despachantePorcentaje').value) || 0;
            const flete = parseFloat(document.getElementById('flete').value) || 0;
            const seguroPorcentaje = parseFloat(document.getElementById('seguroPorcentaje').value) || 0;
            const gastosVariosPorcentaje = parseFloat(document.getElementById('gastosVariosPorcentaje').value) || 0;
            const ingBrutosPercepcionPorcentaje = parseFloat(document.getElementById('ingBrutosPercepcionPorcentaje').value) || 0;
            const ingBrutosSaldoPorcentaje = parseFloat(document.getElementById('ingBrutosSaldoPorcentaje').value) || 0;
            const tasaSeguridad = parseFloat(document.getElementById('tasaSeguridad').value) || 0;

            const ventaNeta = valorVenta / (1 + iva / 100);
            const costoMercaderia = valorFOB;
            
            let baseImponible = valorFOB + flete;
            let seguro = baseImponible * seguroPorcentaje / 100;
            baseImponible = valorFOB + flete + seguro;
            seguro = baseImponible * seguroPorcentaje / 100;
            baseImponible = valorFOB + flete + seguro;
            
            const despachante = baseImponible * despachantePorcentaje / 100;
            const gastosVarios = baseImponible * gastosVariosPorcentaje / 100;
            const ingBrutosPercepcion = baseImponible * ingBrutosPercepcionPorcentaje / 100;
            const ingBrutosSaldo = (ventaNeta * ingBrutosSaldoPorcentaje / 100) - ingBrutosPercepcion;
            
            const gastosVariablesTotales = despachante + flete + seguro + gastosVarios + 
                                         ingBrutosPercepcion + ingBrutosSaldo + tasaSeguridad;
            
            const comisionTotal = ventaDistribuidor ? (ventaNeta * comisionConcesionario / 100) : 0;
            const margenBruto = ventaNeta - costoMercaderia - gastosVariablesTotales - comisionTotal;
            
            const montoAnticipo = valorVenta * anticipo / 100;
            const montoFinanciado = valorVenta - montoAnticipo;
            
            const tasaMensual = tasaFinanciacion / 100 / 12;
            const cuotaMensual = cuotas > 0 && tasaMensual > 0 ? 
                (montoFinanciado * tasaMensual * Math.pow(1 + tasaMensual, cuotas)) / 
                (Math.pow(1 + tasaMensual, cuotas) - 1) : montoFinanciado / cuotas;
            
            const totalCuotasNominal = cuotaMensual * cuotas;
            const costoFinanciero = totalCuotasNominal - montoFinanciado;
            
            const tasaDescuentoMensual = tasaDescuento / 100 / 12;
            let valorPresenteCuotas = 0;
            for (let i = 1; i <= cuotas; i++) {
                valorPresenteCuotas += cuotaMensual / Math.pow(1 + tasaDescuentoMensual, i);
            }
            
            const valorPresenteTotal = montoAnticipo + valorPresenteCuotas;
            const perdidaFinanciera = totalCuotasNominal - valorPresenteCuotas;
            const totalCostosGastos = costoMercaderia + gastosVariablesTotales + comisionTotal + perdidaFinanciera;
            
            const ingresoTotal = ventaNeta + costoFinanciero;
            const contribucionNeta = ingresoTotal - totalCostosGastos;
            
            const margenBrutoPorc = ventaNeta > 0 ? (margenBruto / ventaNeta) * 100 : 0;
            const margenNetoPorcentaje = ingresoTotal > 0 ? (contribucionNeta / ingresoTotal) * 100 : 0;
            const puntoEquilibrio = contribucionNeta > 0 ? gastosFijos / contribucionNeta : 0;

            mostrarResultados({
                ventaNeta,
                costoMercaderia,
                gastosVariablesTotales,
                comisionTotal,
                margenBruto,
                contribucionNeta,
                valorPresenteTotal,
                margenBrutoPorc,
                margenNetoPorcentaje,
                puntoEquilibrio,
                cuotaMensual,
                montoAnticipo,
                montoFinanciado,
                ventaDistribuidor,
                costoFinanciero,
                totalCuotasNominal,
                perdidaFinanciera,
                totalCostosGastos,
                ingresoTotal,
                valorVenta: valorVenta, // Agregamos valor con IVA para el markup
                baseImponible,
                tasaDescuento,
                alertas: {
                    margenMinimo: alertaMargenMinimo,
                    equilibrioMaximo: alertaEquilibrioMaximo,
                    margenExcelente: alertaMargenExcelente,
                    tasaCritica: alertaTasaCritica
                },
                desglose: {
                    despachante,
                    flete,
                    seguro,
                    gastosVarios,
                    ingBrutosPercepcion,
                    ingBrutosSaldo,
                    tasaSeguridad
                },
                porcentajes: {
                    despachantePorcentaje,
                    seguroPorcentaje,
                    gastosVariosPorcentaje,
                    ingBrutosPercepcionPorcentaje,
                    ingBrutosSaldoPorcentaje
                }
            });
        }

        function mostrarResultados(calc) {
            const resultadosDiv = document.getElementById('resultados');
            
            const alertas = generarAlertas(calc);
            const decision = determinarSemaforo(calc);
            
            const rentabilidadBuena = calc.margenNetoPorcentaje > 15;
            const equilibrioRazonable = calc.puntoEquilibrio < 10;
            const margenSaludable = calc.margenBrutoPorc > 20;
            
            let analisis1, analisis2, analisis3;
            
            if (rentabilidadBuena && margenSaludable) {
                analisis1 = "üìà <strong>Rentabilidad S√≥lida:</strong> Margen neto del " + calc.margenNetoPorcentaje.toFixed(1) + "% indica una operaci√≥n financieramente atractiva con contribuci√≥n positiva al flujo de caja.";
            } else if (calc.contribucionNeta > 0) {
                analisis1 = "‚ö†Ô∏è <strong>Rentabilidad Ajustada:</strong> Operaci√≥n viable pero con m√°rgenes comprometidos. Evaluar optimizaci√≥n de costos variables o ajuste de precios.";
            } else {
                analisis1 = "üö® <strong>Alerta Financiera:</strong> Operaci√≥n genera p√©rdidas. Requiere reestructuraci√≥n inmediata de costos o reconsiderar viabilidad comercial.";
            }
            
            if (equilibrioRazonable) {
                analisis2 = "‚úÖ <strong>Escalabilidad Positiva:</strong> Con " + calc.puntoEquilibrio.toFixed(1) + " operaciones mensuales cubrimos gastos fijos. Meta alcanzable para estructura actual.";
            } else if (calc.puntoEquilibrio < 20) {
                analisis2 = "‚ö° <strong>Desaf√≠o Operativo:</strong> Necesitamos " + calc.puntoEquilibrio.toFixed(1) + " operaciones/mes para equilibrio. Revisar capacidad comercial y estrategia de volumen.";
            } else {
                analisis2 = "üéØ <strong>Revisi√≥n Estrat√©gica:</strong> Punto de equilibrio elevado (" + calc.puntoEquilibrio.toFixed(1) + " ops/mes). Considerar reestructuraci√≥n de gastos fijos o modelo comercial.";
            }
            
            if (calc.perdidaFinanciera > calc.costoFinanciero * 2) {
                analisis3 = "üí∞ <strong>Oportunidad Financiera:</strong> Tasa de descuento genera p√©rdida significativa. Evaluar acortar plazos de cobro o ajustar pol√≠tica de financiaci√≥n.";
            } else if (calc.margenBrutoPorc > 25) {
                analisis3 = "üöÄ <strong>Posici√≥n Competitiva:</strong> Margen bruto robusto (" + calc.margenBrutoPorc.toFixed(1) + "%) sugiere pricing power. Oportunidad para incrementar volumen manteniendo rentabilidad.";
            } else {
                analisis3 = "üé≤ <strong>Gesti√≥n de M√°rgenes:</strong> Operaci√≥n en rango est√°ndar. Monitorear competencia y evaluar oportunidades de diferenciaci√≥n para proteger rentabilidad.";
            }
            
            resultadosDiv.innerHTML = `
                <div class="semaforo-container">
                    <div class="semaforo-item semaforo-aprobar ${decision === 'aprobar' ? 'semaforo-activo' : ''}">
                        <div class="semaforo-icon">üü¢</div>
                        <div class="semaforo-text">Aprobar</div>
                    </div>
                    <div class="semaforo-item semaforo-revisar ${decision === 'revisar' ? 'semaforo-activo' : ''}">
                        <div class="semaforo-icon">üü°</div>
                        <div class="semaforo-text">Revisar</div>
                    </div>
                    <div class="semaforo-item semaforo-rechazar ${decision === 'rechazar' ? 'semaforo-activo' : ''}">
                        <div class="semaforo-icon">üî¥</div>
                        <div class="semaforo-text">Rechazar</div>
                    </div>
                </div>

                ${alertas.length > 0 ? `
                <div class="alertas-container">
                    ${alertas.map(alerta => `
                        <div class="alerta alerta-${alerta.tipo}">
                            <span>${alerta.icono}</span>
                            <span>${alerta.mensaje}</span>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                <div class="summary-metrics">
                    <div class="metric-card">
                        <div class="metric-label">Contribuci√≥n Neta</div>
                        <div class="metric-value ${calc.contribucionNeta < 0 ? 'negative' : ''}">${formatCurrency(calc.contribucionNeta)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Margen Bruto %</div>
                        <div class="metric-value">${formatPercentage(calc.margenBrutoPorc)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Margen Neto %</div>
                        <div class="metric-value">${formatPercentage(calc.margenNetoPorcentaje)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Punto de Equilibrio</div>
                        <div class="metric-value">${calc.puntoEquilibrio.toFixed(2)} unidades</div>
                    </div>
                </div>

                <div class="result-breakdown">
                    <h3>üìã Resumen del Negocio</h3>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Valor FOB:</span>
                        <span class="breakdown-value">${formatCurrency(calc.costoMercaderia)}</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Valor de Venta (CON IVA):</span>
                        <span class="breakdown-value">${formatCurrency(calc.valorVenta)}</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Markup sobre FOB:</span>
                        <span class="breakdown-value">${((calc.valorVenta / calc.costoMercaderia) * 100).toFixed(1)}%</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Gastos Variables Totales:</span>
                        <span class="breakdown-value">${formatCurrency(calc.gastosVariablesTotales)}</span>
                    </div>
                    ${calc.ventaDistribuidor ? `
                    <div class="breakdown-item">
                        <span class="breakdown-label">Comisi√≥n Distribuidor:</span>
                        <span class="breakdown-value">${formatCurrency(calc.comisionTotal)}</span>
                    </div>
                    ` : ''}
                    <div class="breakdown-item">
                        <span class="breakdown-label">Costo Financiero:</span>
                        <span class="breakdown-value">${formatCurrency(calc.costoFinanciero)}</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">P√©rdida por Descuento:</span>
                        <span class="breakdown-value">${formatCurrency(calc.perdidaFinanciera)}</span>
                    </div>
                    <div style="margin: 15px 0; padding: 15px 0; border-top: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6;">
                        <div style="font-weight: bold; color: #3498db; margin-bottom: 10px; font-size: 1rem;">üí≥ Forma de Pago</div>
                        <div class="breakdown-item" style="border-bottom: none; padding: 4px 0;">
                            <span class="breakdown-label">Anticipo:</span>
                            <span class="breakdown-value">${formatCurrency(calc.montoAnticipo)}</span>
                        </div>
                        <div class="breakdown-item" style="border-bottom: none; padding: 4px 0;">
                            <span class="breakdown-label">Cuota Mensual:</span>
                            <span class="breakdown-value">${formatCurrency(calc.cuotaMensual)}</span>
                        </div>
                    </div>
                    <div class="breakdown-item" style="border-top: 2px solid #3498db; padding-top: 12px; margin-top: 8px; font-weight: bold;">
                        <span class="breakdown-label">Total Ingresos:</span>
                        <span class="breakdown-value">${formatCurrency(calc.ingresoTotal)}</span>
                    </div>
                    <div class="breakdown-item" style="border-bottom: none;">
                        <span class="breakdown-label">Total Costos:</span>
                        <span class="breakdown-value">${formatCurrency(calc.totalCostosGastos)}</span>
                    </div>
                </div>

                <div class="result-breakdown">
                    <h3>üéØ An√°lisis Ejecutivo - Perspectiva CFO</h3>
                    <div style="margin-bottom: 12px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid #3498db; border-radius: 8px; font-size: 0.95rem; line-height: 1.5;">
                        ${analisis1}
                    </div>
                    <div style="margin-bottom: 12px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid #3498db; border-radius: 8px; font-size: 0.95rem; line-height: 1.5;">
                        ${analisis2}
                    </div>
                    <div style="margin-bottom: 0; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid #3498db; border-radius: 8px; font-size: 0.95rem; line-height: 1.5;">
                        ${analisis3}
                    </div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    clearTimeout(this.timeout);
                    this.timeout = setTimeout(calcular, 500);
                });
            });
            
            calcular();
        });
    </script>
</body>
</html>
